
$client = new Google_Client();
$client->setApplicationName(APPLICATION_NAME);
$client->setScopes(SCOPES);
$client->setAuthConfigFile(CLIENT_SECRET_PATH);
$client->setAccessType('offline');

// Load previously authorized credentials from a file.
$credentialsPath = expandHomeDirectory(CREDENTIALS_PATH);
if (file_exists($credentialsPath)) {
    $accessToken = file_get_contents($credentialsPath);
}
else {
    // Request authorization from the user.
    $authUrl = $client->createAuthUrl();
    print($authUrl);

    $url = filter_var($authUrl, FILTER_SANITIZE_URL);
    header("location: $url");

    if (isset($_GET['code'])) {
        $authCode = trim($_GET['code']);
        $accessToken = $client->authenticate($authCode);
        $client->setAccessToken($accessToken);
    }

    // Refresh the token if it's expired.
    if ($client->isAccessTokenExpired()) {
        $client->refreshToken($client->getRefreshToken());
        file_put_contents($credentialsPath, $client->getAccessToken());
    }


    // Store the credentials to disk.
    if (!file_exists(dirname($credentialsPath))) {
        mkdir(dirname($credentialsPath), 0700, true);

        file_put_contents($credentialsPath, $accessToken);
        printf("Credentials saved to %s\n", $credentialsPath);
    }


    //printf("Open the following link in your browser:\n%s\n", $authUrl);
    //print 'Enter verification code: ';
    //header("location :$authUrl");
    //print('<br/><br/>');
    /*
      $url = filter_var($authUrl, FILTER_SANITIZE_URL);
      //$url = "http://localhost/calendar/index.php";
      header("location: $url");
      if (isset($_GET['code'])) {
      echo 'access';
      $url = "http://localhost/calendar/index.php";
      $client->authenticate($_GET['code']);
      // $_SESSION['access_token'] = $client->getAccessToken();
      $accessToken = $client->authenticate($authCode);
      $client->setAccessToken($authCode);
      $client->setAccessToken($accessToken);
      header('Location: ' . filter_var($url, FILTER_SANITIZE_URL));
      }
     */

    //$authCode = trim(fgets(STDIN));
    // Exchange authorization code for an access token.
    //$accessToken = $client->authenticate($authCode);
    //header("Location:index.php?access=granted");
    // Store the credentials to disk.
    if (!file_exists(dirname($credentialsPath))) {
        mkdir(dirname($credentialsPath), 0700, true);
    }
    file_put_contents($credentialsPath, $accessToken);
    printf("Credentials saved to %s\n", $credentialsPath);
}


// Refresh the token if it's expired.
if ($client->isAccessTokenExpired()) {
    $client->refreshToken($client->getRefreshToken());
    file_put_contents($credentialsPath, $client->getAccessToken());
}